---
title: "Tutorial (week 2) B: text mining"
output: html_notebook
    toc: true
    toc_depth: 2
---

# Step 0: check and install needed packages. Load the libraries and functions. 

```{r, message=FALSE, warning=FALSE}
packages.used=c("rvest", "tibble", "qdap", 
                "sentimentr", "gplots", "dplyr",
                "tm", "syuzhet", "factoextra", 
                "beeswarm", "scales", "RColorBrewer",
                "RANN", "tm", "topicmodels")
# check packages that need to be installed.
packages.needed=setdiff(packages.used, 
                        intersect(installed.packages()[,1], 
                                  packages.used))
# install additional packages
if(length(packages.needed)>0){
  install.packages(packages.needed, dependencies = TRUE)
}
# load packages
library("rvest")
library("tibble")
# You may need to run
# sudo ln -f -s $(/usr/libexec/java_home)/jre/lib/server/libjvm.dylib /usr/local/lib
# in order to load qdap
library("qdap")
library("sentimentr")
library("gplots")
library("dplyr")
library("tm")
library("syuzhet")
library("factoextra")
library("beeswarm")
library("scales")
library("RColorBrewer")
library("RANN")
library("tm")
library("topicmodels")
source("../lib/plotstacked.R")
source("../lib/speechFuncs.R")
```
This notebook was prepared with the following environmental settings.

```{r}
print(R.version)
```



# Step 1: Data harvest: scrap speech URLs from <http://www.presidency.ucsb.edu/>.

Following the example of [Jerid Francom](https://francojc.github.io/2015/03/01/web-scraping-with-rvest-in-r/), we used [Selectorgadget](http://selectorgadget.com/) to choose the links we would like to scrap. For this project, we selected all inaugural addresses of past presidents, nomination speeches of major party candidates and farewell addresses. We also included several public speeches from Donald Trump for our textual analysis of presidential speeches. 

```{r, eval = FALSE, message=FALSE, warning=FALSE}
### Inauguaral speeches
main.page <- read_html(x = "http://www.presidency.ucsb.edu/inaugurals.php")
# Get link URLs
# f.speechlinks is a function for extracting links from the list of speeches. 
inaug=f.speechlinks(main.page)
#head(inaug)
as.Date(inaug[,1], format="%B %e, %Y")
inaug=inaug[-nrow(inaug),] # remove the last line, irrelevant due to error.
#### Nomination speeches (this webpage no longer exsit)
# main.page=read_html("http://www.presidency.ucsb.edu/nomination.php")
# Get link URLs
# nomin <- f.speechlinks(main.page)
#head(nomin)
#
#### Farewell speeches
main.page=read_html("http://www.presidency.ucsb.edu/farewell_addresses.php")
# Get link URLs
farewell <- f.speechlinks(main.page)
#head(farewell)
```

# Step 2: Using speech metadata posted on <http://www.presidency.ucsb.edu/>, we prepared CSV data sets for the speeches we will scrap. 

```{r}
inaug.list=read.csv("https://raw.githubusercontent.com/TZstatsADS/ADS_Teaching/master/Tutorials/wk2-TextMining/data/inauglist.csv", stringsAsFactors = FALSE)
nomin.list=read.csv("https://raw.githubusercontent.com/TZstatsADS/ADS_Teaching/master/Tutorials/wk2-TextMining/data/nominlist.csv", stringsAsFactors = FALSE)
farewell.list=read.csv("https://raw.githubusercontent.com/TZstatsADS/ADS_Teaching/master/Tutorials/wk2-TextMining/data/farewelllist.csv", stringsAsFactors = FALSE)
```


We assemble all scrapped speeches into one list. Note here that we don't have the full text yet, only the links to full text transcripts. 

# Step 3: scrap the texts of speeches from the speech URLs.

```{r}
speech.list=rbind(inaug.list, 
                  nomin.list, 
                  farewell.list)
speech.list$type=c(rep("inaug", nrow(inaug.list)),
                   rep("nomin", nrow(nomin.list)),
                   rep("farewell", nrow(farewell.list)))
#speech.url=rbind(inaug, 
#                 nomin, 
#                 farewell)
#speech.list=cbind(speech.list, speech.url)
```


```{r}
# Loop over each row in speech.list
speech.list$fulltext=NA
for(i in seq(nrow(speech.list))) {
  #text <- read_html(speech.list$urls[i]) %>% # load the page
  #  html_nodes(".displaytext") %>% # isloate the text
  #  html_text() # get the text
  text.input=readtext(file=paste("../data/fulltext/", 
                                   speech.list$type[i],
                                   speech.list$File[i], "-", 
                                    speech.list$Term[i], ".txt"))
  print(text.input)
  speech.list$fulltext[i]=text.input
  # Create the file name
  #filename <- paste0("../data/fulltext/", 
  #                   speech.list$type[i],
  #                   speech.list$File[i], "-", 
  #                   speech.list$Term[i], ".txt")
  #sink(file = filename) %>% # open file to write 
  #cat(text)  # write the file
  #sink() # close the file
}
```

```{r}
```
Trump, as president-elect that has not been a politician, do not have a lot of formal speeches yet. For our textual analysis, we manually add several public transcripts from Trump:
+ [Transcript: Donald Trump's full immigration speech, annotated. LA Times, 08/31/2016](http://www.latimes.com/politics/la-na-pol-donald-trump-immigration-speech-transcript-20160831-snap-htmlstory.html)
+ [Transcript of Donald Trumpâ€™s speech on national security in Philadelphia - The Hill, 09/07/16](http://thehill.com/blogs/pundits-blog/campaign/294817-transcript-of-donald-trumps-speech-on-national-security-in)
+ [Transcript of President-elect Trump's news conference
CNBC, 01/11/2017](http://www.cnbc.com/2017/01/11/transcript-of-president-elect-donald-j-trumps-news-conference.html)

```{r}
speech1=paste(readLines("https://raw.githubusercontent.com/TZstatsADS/ADS_Teaching/master/Tutorials/wk2-TextMining/data/fulltext/SpeechDonaldTrump-NA.txt", 
                  n=-1, skipNul=TRUE),
              collapse=" ")
speech2=paste(readLines("https://raw.githubusercontent.com/TZstatsADS/ADS_Teaching/master/Tutorials/wk2-TextMining/data/fulltext/SpeechDonaldTrump-NA2.txt", 
                  n=-1, skipNul=TRUE),
              collapse=" ")
speech3=paste(readLines("https://raw.githubusercontent.com/TZstatsADS/ADS_Teaching/master/Tutorials/wk2-TextMining/data/fulltext/PressDonaldTrump-NA.txt", 
                  n=-1, skipNul=TRUE),
              collapse=" ")
Trump.speeches=data.frame(
  President=rep("Donald J. Trump", 3),
  File=rep("DonaldJTrump", 3),
  Term=rep(0, 3),
  Party=rep("Republican", 3),
  Date=c("August 31, 2016", "September 7, 2016", "January 11, 2017"),
  Words=c(word_count(speech1), word_count(speech2), word_count(speech3)),
  Win=rep("yes", 3),
  type=rep("speeches", 3),
  links=rep(NA, 3),
  urls=rep(NA, 3),
  fulltext=c(speech1, speech2, speech3)
)
speech.list=rbind(speech.list, Trump.speeches)
```

```{r}
sentence.list=
  sentence.list%>%
  filter(!is.na(word.count)) 
```














